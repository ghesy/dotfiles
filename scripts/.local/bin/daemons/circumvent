#!/bin/sh
# download, configure and start the psiphon proxy client.

# ==========
# = Config
# ==========

# psiphon-client's github path
repo=Psiphon-Labs/psiphon-tunnel-core-binaries
repofile=linux/psiphon-tunnel-core-x86_64

# where to put the psiphon binary and configs
dir=~/.local/share/circumvent
bin=psiphon-client

# ports
socks_port=9050
http_port=8082

# ==========
# ==========

# wait until we have internet
echo waiting for internet connectivity...
while true; do
    case $(nmcli -g general.ip4-connectivity dev show) in *full*) break ;; esac
    sleep 30
done

die() {
    echo "Circumvent: Error: $*"
    notify-send Circumvent "Error: $*"
    exit 1
}

# install dependencies
echo checking dependencies...
command -v jq >/dev/null || die 'please install "jq".'

mkdir -p "${dir:?}" || die "couldn't make directory $dir."
cd "$dir" || die "couldn't change directory to $dir."

# update psiphon if a newer version is available
echo checking for updates...
url="https://raw.githubusercontent.com/${repo:?}/master/${repofile:?}"
apiurl="https://api.github.com/repos/$repo/commits?path=$(echo "$repofile" | sed 's/\//%2F/g')&page=1&per_page=1"
lastcommit=$(date -d "$(curl -s "$apiurl" | jq -r '.[0].commit.committer.date')" +%s)
[ ! -x "${bin:?}" ] || [ "$lastcommit" -gt "$(date +%s)" ] && {
    rm -f "$bin"
    echo updating...
    aria2c --no-conf -k1M -x5 -o"$bin" "$url" || die 'failed to download psiphon.'
    chmod 755 "$bin"
}

# generate psiphon's config file
echo writing the config file...
cat << eof > config || die "failed to write psiphon's config."
{
"LocalHttpProxyPort":$http_port,
"LocalSocksProxyPort":$socks_port,
"PropagationChannelId":"FFFFFFFFFFFFFFFF",
"RemoteServerListDownloadFilename":"remote_server_list",
"RemoteServerListSignaturePublicKey":"MIICIDANBgkqhkiG9w0BAQEFAAOCAg0AMIICCAKCAgEAt7Ls+/39r+T6zNW7GiVpJfzq/xvL9SBH5rIFnk0RXYEYavax3WS6HOD35eTAqn8AniOwiH+DOkvgSKF2caqk/y1dfq47Pdymtwzp9ikpB1C5OfAysXzBiwVJlCdajBKvBZDerV1cMvRzCKvKwRmvDmHgphQQ7WfXIGbRbmmk6opMBh3roE42KcotLFtqp0RRwLtcBRNtCdsrVsjiI1Lqz/lH+T61sGjSjQ3CHMuZYSQJZo/KrvzgQXpkaCTdbObxHqb6/+i1qaVOfEsvjoiyzTxJADvSytVtcTjijhPEV6XskJVHE1Zgl+7rATr/pDQkw6DPCNBS1+Y6fy7GstZALQXwEDN/qhQI9kWkHijT8ns+i1vGg00Mk/6J75arLhqcodWsdeG/M/moWgqQAnlZAGVtJI1OgeF5fsPpXu4kctOfuZlGjVZXQNW34aOzm8r8S0eVZitPlbhcPiR4gT/aSMz/wd8lZlzZYsje/Jr8u/YtlwjjreZrGRmG8KMOzukV3lLmMppXFMvl4bxv6YFEmIuTsOhbLTwFgh7KYNjodLj/LsqRVfwz31PgWQFTEPICV7GCvgVlPRxnofqKSjgTWI4mxDhBpVcATvaoBl1L/6WLbFvBsoAUBItWwctO2xalKxF5szhGm8lccoc5MZr8kfE0uxMgsxz4er68iCID+rsCAQM=",
"RemoteServerListUrl":"https://s3.amazonaws.com//psiphon/web/mjr4-p23r-puwl/server_list_compressed",
"SponsorId":"FFFFFFFFFFFFFFFF",
"UseIndistinguishableTLS":true
}
eof

# start psiphon
echo starting "$bin"...
killall -q "$bin"
trap 'echo exiting...; pkill -P$$' HUP INT TERM
"$dir/$bin" -config "$dir"/config 2>&1 | while IFS= read -r line; do
    case $line in
        *Tunnels*)
            curl -s --socks5 localhost:9050 ping.archlinux.org >/dev/null && {
                echo "$bin" connected.
                notify-send Circumvent Connected.
            }
        ;;
        *PortInUse*)
            die "one of the ports ($socks_port, $http_port) is in use, probably by Tor."
        ;;
    esac
done &
echo "$bin" started, connecting...
wait
