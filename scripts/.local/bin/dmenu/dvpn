#!/bin/sh
# a simple dmenu interface for windscibe and protonvpn.

wind_locations='Best
Crumpets
Custard
Ranch
Seine
Castle
Canal
Ataturk'

pvpn_locations='US
NL
JP
Fastest'

notif() {
    while IFS= read -r line; do case $line in
        Visit*|*graphical*|*symlink*|*changed*) ;;
        *[a-zA-Z]*) notify-send "$1" "$line" ;;
    esac; done
}

# run the given command unbuffered
unbuffer() {
    script -qfc "$(/usr/bin/printf '%q ' "$@")" /dev/null
}

case $(printf 'Connect\nDisconnect\n' | dmenu -p VPN) in
    Connect)
        case $(printf 'ProtonVPN\nWindscribe\n' | dmenu -p VPN) in
            ProtonVPN)
                location=$(echo "$pvpn_locations" | dmenu -p Location:)
                [ ${location:?} = Fastest ] && location=-f || location="--cc $location"
                unbuffer sudo -A protonvpn c $location | notif ProtonVPN ;;
            Windscribe)
                location=$(echo "$wind_locations" | dmenu -p Location:)
                [ ${location:?} = Best ] && location=
                windscribe connect $location | stdbuf -o0 tr -d '\b/|\\-' |
                    notif Windscribe ;;
        esac ;;
    Disconnect)
        case $(pgrep -ax openvpn) in
            *windscribe*) windscribe disconnect | notif Windscribe ;;
            *pvpn*) unbuffer sudo -A protonvpn d | notif ProtonVPN ;;
            *) echo No VPN connection found. | notif dvpn ;;
        esac ;;
esac
