#!/bin/sh
# ask for a system action.

actions='鈴 Sleep
鈴 Hibernate
⏻ Poweroff
 Reboot
 Logout'

# the -shb and -shf dmenu color options require dmenu's fuzzyhighlight patch.
colors='-sb #657432 -shb #657432 -sf white -shf gray'

main() {
    action=$1
    [ -z "$1" ] && action=$(echo "$actions" | dmenu -p 'Do what?' $colors)
    case $(echo $action | tr A-Z a-z) in
        *sleep)
            can_hibernate &&
                loginctl suspend-then-hibernate ||
                loginctl suspend
        ;;
        *hiber*)
            if can_hibernate; then
                ask 'Hibernate?' && loginctl hibernate
            else
                notify-send 'Hibernation is not enabled on this machine.'
            fi
        ;;
        *reboot) rebootfn ;;
        *poweroff) ask 'Poweroff?' && loginctl poweroff ;;
        *logout) ask 'Logout?' && killall xinit ;;
    esac
}

ask() {
    ans=$(printf "No\\nYes" | dmenu -p "$*" \
        -nb darkred -nhb darkred -nf darkgray -nhf darkgray \
        -sb maroon -shb maroon -sf white -shf gray)
    [ "$ans" = Yes ] && return 0 || return 1
}

can_hibernate() {
    grep -q 'resume=' /proc/cmdline
}

rebootfn() {
    os="$(ask_reboot_os)"
    case $? in
        9) cmd=true ;;
        0) cmd='sudo -A grub-reboot' ;;
        *) return 1 ;;
    esac
    ask 'Reboot?' || return 1
    $cmd "$os" && loginctl reboot
}

ask_reboot_os() {
    command -v grub-reboot >/dev/null || return 9
    command -v grub-entries >/dev/null || return 9
    entries=$(sudo -A grub-entries -g)
    [ "$(echo "$entries" | wc -l)" -le 1 ] && return 9
    sel=$(echo "$entries" | dmenu -p 'Reboot to:' $colors) || return 1
    echo "$sel" | cut -d' ' -f2-
}

main "$@"
