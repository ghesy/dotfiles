#!/bin/sh
# select and open man pages using dmenu.
#
# if - is given as the first argument, dman will read stdin and
# look for referenced utilities in the form of UTIL(SECTION),
# it will then ask for one using dmenu and open it.

set -e

menu() {
    dmenu -l 10 ${WINDOWID:+-w $WINDOWID}
}

prnt() {
    printf '%s\n' "$@"
}

if [ "$1" = '-' ]; then
    list=$(sed '1d;$d' | col -b | sed -Ez 's/‐\n\s*//g' |
        grep -Eo '[0-9a-zA-Z_-]+\(([1-9nl]|[0-3]p)\)' |
        cat -n | sort -ufk2 | sort -n | cut -f2-)
    [ -n "$list" ] && man=$(prnt "$list" | menu)
else
    # get the list of available man pages
    list=$(
        IFS=:
        find $(man -w) -type f \
            -iname '*.[1-9nl]' -or -iname '*.[1-9nl].gz' -or \
            -iname '*.[0-3]p' -or -iname '*.[0-3]p.gz'
    )

    # ask for a man page from the user
    man=$(prnt "$list" | rev | cut -d/ -f1 | rev | cut -d. -f1 | sort -u | menu)

    # get the available sections of the selected man page
    sec=$(prnt "$list" | grep -Po "^.*/\Q${man:?}\E\.\K[0-9nl]p?(?=(\.gz)?)" | sort)

    # if the man page has multiple sections, ask the user to select one of them
    [ "$(prnt "$sec" | wc -l)" -gt 1 ] && sec=$(prnt "$sec" | menu)
fi

# open the man page in a terminal window
[ -n "$man" ]
setsid -f ${TERMINAL:?} -e man ${sec:+"$sec"} "$man" >/dev/null 2>&1
