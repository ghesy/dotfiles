#!/bin/sh
# select and open man pages using dmenu.
#
# if - is given as the first argument, dman will read stdin and
# look for referenced utilities in the form of UTIL(SECTION),
# it will then ask for one using dmenu and open it.

set -e

menu() {
    dmenu -l 10 ${WINDOWID:+-w $WINDOWID}
}

prnt() {
    printf '%s\n' "$@"
}

if [ "$1" = '-' ]; then

    # make a list of referenced man pages from stdin
    list=$(
        sed '1d;$d' | col -b | sed -Ez 's/â€\n\s*//g' |
            grep -Eo '[0-9a-zA-Z._-]+\([0-9nl][a-zA-Z]*\)' |
            cat -n | sort -ufk2 | sort -n | cut -f2-
    )

    # ask for a man page from the user
    [ -n "$list" ] && man=$(prnt "$list" | menu)

else

    # make a list of available man pages
    list=$(
        IFS=:
        for d in $(man -w); do
            find -L "$d"/man[0-9nl]* -type f
        done
    )

    # ask for a man page from the user
    man=$(prnt "$list" | grep -Po '.*/\K\S+(?=\.[0-9nl][a-zA-Z]*(\.gz)?)' | sort -u | menu)

    # get the available sections of the selected man page
    sec=$(prnt "$list" | grep -Po "^.*/\Q${man:?}\E\.\K[0-9nl][a-zA-Z]*(?=(\.gz)?)" | sort)

    # if the man page has multiple sections, ask the user to select one of them
    [ "$(prnt "$sec" | wc -l)" -gt 1 ] && sec=$(prnt "$sec" | menu)

fi

# open the man page in a terminal window
[ -n "$man" ]
setsid -f ${TERMINAL:?} -e man ${sec:+"$sec"} "$man" >/dev/null 2>&1
