#!/bin/bash
host='http://localhost:6800/rpc'

opts=(
    max-concurrent-downloads
    max-overall-download-limit
    optimize-concurrent-downloads
)

# getval() {
#     printf '%s\n' "${o:?}" | grep -FA1 "'${1:?}'" | tail -1 | cut -d"'" -f2
# }
# s=$(for opt in $opts; do printf '%s: %s\n' "$opt" "$(getval "$opt")"; done)
# echo "$s"

# xmlrpc "${host:?}" aria2.getGlobalOption | while IFS= read -r line; do
#     case $line in
#         "  Key:   String: '"
#     esac
# done

opts=("${opts[@]/#/  Key:   String: \'}")
opts=("${opts[@]/%/\'|}")
ptrn=$(printf '%s' "${opts[@]}")

while :; do
    o=$(xmlrpc "${host:?}" aria2.getGlobalOption) || exit
    sel=$(
        printf '%s\n' "$o" |
            grep -EA1 "${ptrn%|}" | cut -d"'" -f2 |
            sed -z 's/\n/: /g;s/: --: /\n/g;s/:.$/\n/g' | dmenu -l 30
    ) || exit
    val=$(dmenu $w -p 'new value:' <&-) || exit
done
