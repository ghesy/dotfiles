#!/bin/sh
# do various things to firefox.

# config
key_gotourgent='super+u' # key that makes the wm focus the urgent windown
key_togglefloating='super+F' # key that makes tiled windows floating

main() {
    set -e
    wid=$(xdotool getactivewindow)
    [ "$(xdotool getwindowclassname "$wid")" = firefox ] || return
    # clearmodifiers
    case $(printf 'Fix Focus\nMerge\nShow History\n' | dmenu -w "$wid") in
        'Fix Focus') fixfocus ;;
        'Merge') merge ;;
        'Show History') showhistory ;;
    esac
}

# if you use a vi-like extention for firefox (ex. trydactyl),
# and the addressbar is focused, there is no way to focus on the
# webpage again without using the mouse or typing something in the
# addressbar and pressing enter.
# but this script gives the focus back to the main page, by
# right and then left clicking in the center of currently active window.
fixfocus() {
    xdotool getactivewindow mousemove --window %1 --polar 0 0 click 3 \
    mousemove_relative -- -20 -20 click 1 mousemove 0 0
}

# open dwm's history side panel and put the selection on the first item.
showhistory() {
    xdotool key --clearmodifiers --delay 100 \
    ctrl+b ctrl+h Tab Tab Down Up
}

# this function puts all the tabs of the currently active firefox window
# into another firefox window that is in the same desktop or dwm tag.
# note: your window manager needs to support the _NET_WM_DESKTOP hint.
# if you use dwm, you need to apply this patch: https://github.com/soystemd/dwm/compare/cc4564f...5ce1409
# the above patch is based on this patch: https://github.com/wor/abs-repo/blob/master/dwm-git/dwm-6.1-netwmdesktop.patch
merge() {
    ff1=$(xdotool getactivewindow)
    ff2=$(xdotool search --onlyvisible --desktop $(xdotool get_desktop) --class firefox | grep -Fvm1 "$ff1")

    geom=$(xdotool getwindowgeometry --shell "$ff2")
    eval "$geom"

    s='sleep 0.1' d='--delay 100' c=--clearmodifiers

    timeout 0.3 xdotool \
        windowstate --remove FULLSCREEN "$ff1" \
        windowsize --sync "$ff1" 400 400 \
        windowmove --sync "$ff1" $((WIDTH/2+X)) $((HEIGHT/2+Y)) \
    || {
        xdotool key $c "${key_togglefloating:?}" $s
        geom=$(xdotool getwindowgeometry --shell "$ff2")
        eval "$geom"
        timeout 5 xdotool \
        windowsize --sync "$ff1" 400 400 \
        windowmove --sync "$ff1" $((WIDTH/2+X)) $((HEIGHT/2+Y))
    }

    timeout 5 xdotool \
        windowactivate "$ff2" $s \
        key $c "${key_gotourgent:?}" \
        windowactivate --sync "$ff2" \
        windowactivate "$ff1" $s \
        key $c "${key_gotourgent:?}" \
        windowactivate --sync "$ff1" \
        mousemove --window "$ff1" 50 10 $s \
        click $c 3 $s \
        key $c $d s Escape $s \
        mousedown $c 1 $s \
        mousemove $((X+WIDTH-100)) $((Y+20)) $s \
        mousemove_relative -- -5 0 $s \
        mouseup $c 1 $s \
        key $c $d ctrl+shift+Tab ctrl+Tab

    xdotool keyup Shift_L Shift_R Control_L Control_R
}

clearmodifiers() {
    xdotool keyup \
        Shift_L Shift_R Control_L Control_R Meta_L Meta_R \
        Alt_L Alt_R Super_L Super_R Hyper_L Hyper_R
}

main "$@"
