#!/bin/sh
# do various things to firefox.

main() {
    set -e
    [ "$(xdotool getactivewindow getwindowclassname)" = firefox ]
    case $1 in
        showhistory|fixfocus|merge) $1 ;;
    esac
}

# open dwm's history side panel and put the selection on the first item.
showhistory() {
    xdotool key --clearmodifiers --delay 100 \
    ctrl+b ctrl+h Tab Tab Down Up
}

# if you use a vi-like extention for firefox (ex. trydactyl),
# and the addressbar is focused, there is no way to focus on the
# webpage again without using the mouse or typing something in the
# addressbar and pressing enter.
# but this script gives the focus back to the main page, by
# right and then left clicking in the center of currently active window.
fixfocus() {
    xdotool getactivewindow mousemove --window %1 --polar 0 0 click 3 \
    mousemove_relative -- -20 -20 click 1 mousemove 0 0
}

# this function puts all the tabs of the currently active firefox window
# into another firefox window that is in the same desktop or dwm tag.
# note: your window manager needs to support the _NET_WM_DESKTOP hint.
# if you use dwm, you need to apply this patch: https://github.com/soystemd/dwm/compare/cc4564f...5ce1409
# the above patch is based on this patch: https://github.com/wor/abs-repo/blob/master/dwm-git/dwm-6.1-netwmdesktop.patch
merge() {
    ff1=$(xdotool getactivewindow)
    ff2=$(xdotool search --desktop $(xdotool get_desktop) --class firefox | grep -Fvm1 "$ff1")
    geom=$(xdotool getwindowgeometry --shell "$ff2")
    eval "$geom"
    s='sleep 0.1' d='--delay 100' c=--clearmodifiers
    timeout 5 xdotool mousemove --window "$ff1" 50 10 \
        key $c $d ctrl+shift+Tab ctrl+Tab \
        click $c 3 \
        key $c $d s Escape \
        mousedown $c 1 \
        mousemove $((X+WIDTH-100)) $((Y+20)) $s \
        mousemove_relative -- -5 0 $s \
        mouseup $c 1 $s \
        mousemove 0 0 $s \
        mousemove --window "$ff2" --polar 0 0 \
        windowactivate --sync "$ff2" $s \
        key $c $d ctrl+shift+Tab ctrl+Tab

    xdotool keyup Shift_L Shift_R Control_L Control_R
}

main "$@"
