#!/bin/sh
# a linux script to lock the system and check system's media players,
# network activity, ssh connections and cpu usage to suspend the system
# if it's been idle for a while.  requires playerctl.

# =================
# = Config
# =================

# system idle time in minutes
timeout=10

# thresholds
net_threshold_kbps=10
cpu_usage_threshold=15

# specify your locker program
locker() { slock ;}

# actions to perform when system is deemed idle
idle_action() { sysact sleep ;}

# system idle checking interval
loop_interval_sec=30

# =================
# = End of Config
# =================

main() {
    check_deps || return 1
    reset_timeout
    while :; do
        sleep $loop_interval_sec
        if is_system_idle; then
            has_timeout_reached && reset_timeout && idle_action
        else
            reset_timeout
        fi
    done &
    locker &
    wait $!
}

has_timeout_reached() {
    [ $(( $(date +%s) - last_activity )) -gt $(( timeout * 60 )) ]
}

reset_timeout() {
    last_activity=$(date +%s)
}

is_system_idle() {
    is_nothing_playing  || { echo playing media detected.;      return 1 ;} &&
    is_ssh_inactive     || { echo ssh connections detected.;    return 1 ;} &&
    is_network_idle     || { echo network activity detected.;   return 1 ;} &&
    is_cpu_idle         || { echo high cpu activity detected.;  return 1 ;} &&
    echo system is idle.
}

is_ssh_inactive() {
    ! pgrep -P "$(pgrep -ox sshd)" >/dev/null 2>&1
}

is_cpu_idle() {
    [ "$(cpu_usage)" -le "$cpu_usage_threshold" ]
}

cpu_usage() {
    eval $(cpu_sample 1)
    sleep 5
    eval $(cpu_sample 2)
    idle=$(( idle2 - idle1 ))
    total=$(( total2 - total1 ))
    echo "100 - 100 * $idle / $total" | bc
}

cpu_sample() {
    awk -v n=$1 '{ idle=$5; for (i=1; i<=NF; i++) total+=$i; exit }
        END { print "idle"n"="idle";total"n"="total }' /proc/stat
}

is_network_idle() {
    [ "$(net_speed)" -le "$net_threshold_kbps" ]
}

net_speed() {
    sec=5
    s1=$(net_sample 1)
    sleep $sec
    s2=$(net_sample 2)
    echo $(( (s2 - s1) / (1024 * sec) ))
}

net_sample() {
    awk -v n=$1 '/:/ && !/lo/ && !/tun/ {s+=$2+$10} END{print s}' /proc/net/dev
}

is_nothing_playing() {
    ! playerctl -a status | grep -iq playing && ! mpc | grep -qi '^\[playing'
}

check_deps() {
    for prog in setsid pkill playerctl; do
        command -v $prog >/dev/null || {
            echo dependency not installed: $prog >&2
            return 1
        }
    done
}

trap 'pkill -P$$' EXIT HUP INT TERM
main "$@"
