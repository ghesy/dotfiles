#!/bin/bash
# see release date of TV show episodes.
# requires episoder(aur) and fzf.
# options:
# -a: search and add new shows.
# -e: export the list of added shows to ~/.config/tv/shows.
# -i: import shows from ~/.config/tv/shows.

conf=~/.config/tv
episoder() { HOME=$conf command episoder "$@" ;}
case $1 in
'')
    episoder update -d90
    { episoder list -Cd90 -n120
        date +%F\ $'\e[1;36m=========='
        date -d 'last month' +%F\ $'\e[1;36m==========' ;} |
        sort -rn | ${PAGER:-less} ;;
-a)
    cmd="episoder search {q} | grep '^[0-9]'"
    printf '\033[5 q'
    show=$(:|fzf --disabled --bind="change:reload:$cmd") &&
        episoder add "${show%%$'\t'*}" && episoder update -d90
    exec "$0" -e ;;
-e)
    paste <(episoder shows | grep -Po '^\[.*\d\] \K\S+') \
        <(episoder shows | grep -E '(, \S+){2}' | rev | cut -d, -f3- | awk '{$1=$1};1' | rev) > $conf/shows ;;
-i)
    cut -f1 $conf/shows | HOME=$conf xargs -rd'\n' -L1 episoder add
    episoder update -d90 ;;
-h)
    cat <<- 'eof'
	options:
	-a search and add new shows.
	-e export the list of added shows to ~/.config/tv/shows.
	-i import shows from ~/.config/tv/shows.
	eof
    ;;
*)
    exec episoder "$@" ;;
esac
