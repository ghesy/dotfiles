#!/bin/bash
# see release date of TV show episodes.
# requires episoder(aur) and fzf.
#
# options:
# -a: search and add new shows.
# -l: list added shows.
# -e: export the list of added shows to ~/.local/share/tv/shows.
# -i: import shows from ~/.local/share/tv/shows.

dbdir=~/.local/share/tv-db
shows=~/.local/share/tv/shows

conf="dateformat=%F
format=%airdate - %show - %seasonx%epnum - %eptitle"

episoder() {
    mkdir -p "${dbdir:?}" &&
        HOME=${dbdir:?} command episoder -c <(printf '%s\n' "${conf:?}") "$@"
}

list_show_names() {
    episoder shows | grep -E '(, \S+){2}' | rev |
        cut -d, -f3- | awk '{$1=$1};1' | rev
}

list_show_ids() {
    episoder shows | grep -Po '^\[.*\d\] \K\S+'
}

export_show_list() {
    mkdir -p "$(dirname "${shows:?}")" &&
        paste <(list_show_ids) <(list_show_names) > "${shows:?}"
}

case $1 in
-l)
    list_show_names ;;
-e)
    export_show_list ;;
'')
    episoder update -d90
    episoder list -i | tac | less ;;
-i)
    cut -f1 "${shows:?}" | while IFS= read -r show; do
        echo importing "$show"...
        episoder add "$show"
    done
    episoder update -d90 ;;
-a)
    cmd="episoder search {q} | grep '^[0-9]'"
    printf '\033[5 q'
    show=$(:|fzf --disabled --bind="change:reload:$cmd") &&
        episoder add "${show%%$'\t'*}" && episoder update -d90 &&
        export_show_list ;;
-h)
    cat <<- 'eof'
	options:
	-a search and add new shows.
	-l list added shows.
	-e export the list of added shows to ~/.local/share/tv/shows.
	-i import shows from ~/.local/share/tv/shows.
	eof
    ;;
*)
    episoder "$@" ;;
esac
