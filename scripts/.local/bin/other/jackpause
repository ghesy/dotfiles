#!/bin/sh
# a daemon that pauses all the playing media upon headphone jack disconnection.
# requires my toggleall script.

main()
{
    pactl subscribe | grep --line-buffered card | while IFS= read -r line; do
        is_current_port_a_speaker_port && toggleall pause
    done
}

is_current_port_a_speaker_port()
{
    get_current_port_info | grep -q speaker
}

get_current_port_info()
{
    sink_info="$(pacmd list-sinks)"
    printf '%s\n' "$sink_info" |
        grep -Pzo '\t{2,}'"$(get_current_port)"'[^\t]*(\t{3,}[^\t]+)+' |
        tr -d '\000'
}

get_current_port()
{
    printf '%s\n' "$sink_info" |
        grep -Em1 -A1000 ' +\* +index' |
        grep -m1 'active port:' |
        cut -d: -f2 |
        tr -d ' <:>'
}

main "$@"
exit
