#!/bin/sh
# download/run the appimage of Bottles.
# https://github.com/bottlesdevs/Bottles

# config
dir=~/.local/share/bottles/bin
github=bottlesdevs/Bottles

case $1 in
-v)
    cd $dir &&
        echo "Current verson: $(echo *.AppImage) ($(stat -c%w ./*.AppImage))" ;;
-h)
    echo "-u    update/download the appimage"
    echo "-l    unlink wine bottles' dirs from user's home dir"
    echo "-v    show version"
    echo "-h    show this help message" ;;
-u)
    # get info on the latest release
    js=$(curl -fsL "https://api.github.com/repos/$github/releases/latest") \
        || exit 1

    # parse the json release info
    j() { printf '%s\n' "$js" | grep -m1 "$1" | cut -d\" -f4 ;}
    url=$(j '"browser_download_url.*\.AppImage"')
    filename=$(j '"name".*\.AppImage"')
    date=$(j '"published_at"')
    version=$(j '"name"')

    # show the current and latest versions for comparison
    [ -f "$dir"/*.AppImage ] && ("$0" -v)
    echo "Latest release: $filename ($date, $version)"

    # prompt the user
    printf 'Continue? [y/N] '
    read ans
    case $ans in y|Y|yes|Yes) ;; *) exit ;; esac

    # download and install the latest version
    aria2c -k1M -x16 -s16 -d"$dir" -o"$filename.tmp" "$url" &&
        mkdir -p "$dir/previous-version" &&
        rm -f "$dir/previous-version"/*.AppImage &&
        mv "$dir"/*.AppImage "$dir/previous-version" &&
        mv "$dir/$filename.tmp" "$dir/$filename" &&
        chmod 755 "$dir/$filename" ;;
-l)
    # unlink wine bottles' dirs from user's home dir
    rmdir ~/Desktop 2>/dev/null
    for d in ~/.local/share/bottles/bottles/*/drive_c/users/*/*; do
        [ -L "$d" ] && rm "$d" && mkdir "$d"
    done ;;
*)
    XDG_DATA_DIRS=/usr/local/share:/usr/share "$dir"/*.AppImage "$@" ;;
esac
