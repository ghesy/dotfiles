#!/bin/sh
# run the given program in the cwd of the current active window.
# requires pslist and xdotool.
# usage: cwdrun <CMD> [ARGS...]

main() {
    [ -n "$*" ] && cd "$(getcwd $(xdotool getactivewindow getwindowpid) | tail -1)" && exec "$@"
}

getcwd() {
    for pid in $(pslist "$1" | grep -o '[0-9]\+'); do
        if istmux $pid; then
            getcwd $(gettmuxpanepid $pid)
            break
        else
            readlink /proc/$pid/cwd | grep -Ev "^$HOME$|^/$|^/proc/"
        fi
    done
}

istmux() {
    f=/proc/$1/cmdline
    [ -f $f ] && [ "$(cut -d '' -f1 $f)" = tmux ]
}

gettmuxpanepid() {
    tmux list-clients -F '#{client_pid} #{pane_pid}' | grep -Po "^${1:?} \K\d+"
}

main "$@"
