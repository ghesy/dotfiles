#!/bin/sh
# login to mutt's email accounts and notify the unread emails.
unread() {
    eval $(egrep '^set.*(imap_user|folder).*=' "${1:?}" | cut -d' ' -f2- | sed 's/\s\+=\s\+/=/g')
    pass=$($(grep '`.*pass ' "$1" | cut -d'`' -f2))
    c() { curl -su "${imap_user:?}:${pass:?}" "${folder:?}/INBOX" -X "$1" ;}
    ids="$(c 'FETCH 1:* (UID FLAGS)' | grep -v Seen | tac | cut -d' ' -f5)"
    count="$(printf "%s${ids:+\n}" "$ids" | wc -l)"
    [ "$count" -le 0 ] && { notify-send " $(basename "$1")" 'No Unread Mail.'; exit ;}
    last_subject="$(c "UID FETCH $(echo "$ids" | head -n1) (ENVELOPE)" | cut -d\" -f4- | grep -Po '^.*?[^\\](?=")' | grep -v '?UTF-8')"
    notify-send " $(basename "$1")" "Unread Count: $count${last_subject:+
Last Subject:
$last_subject}"
}
for f in ~/.local/share/neomutt/accounts/*; do
    [ -f "$f" ] && unread "$f" &
done
wait
