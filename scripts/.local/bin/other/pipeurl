#!/bin/sh
# extract and open URLs from the contents of stdin.
# option -c: take the next thing that is copied to clipboad as a url and open it
# requires dmenu, xurls, clipnotify, xclip, libnotify,
# mpv(+youtube-dl), curl, moreutils, gallery-dl, and tuir(optional).

# config
cache=~/.cache/gallery-dl

[ -n "$1" ] && url="$(printf '%s\n' "$1" | xurls | head -n1)" || url="$(
    xurls | sort -u | ifne dmenu -p 'Select URL' -l 10 ${WINDOWID:+-w $WINDOWID}
)"
[ -z "$url" ] && exit

stream() {
    notify-send -u low PipeURL 'Opening Video...'
    $p mpv -quiet -- "$@" ||
        notify-send PipeURL 'Failed to open the Video.'
}

gdl() {
    imgs=$($p gallery-dl -d "$cache" -- "$@" 2>/dev/null) || return 1
    printf '%s\n' "$imgs" | sed 's/^# //' |
        xargs -d'\n' sh -c 'sxiv -a -- "$@" || mpv -quiet -- "$@"' ''
}

dl() {
    file=$(printf '%s\n' "$1" | md5sum | cut -d' ' -f1)
    if [ ! -r "$cache/$file" ]; then
        $p aria2c -q -x10 -s10 -k1M -m1 --no-conf ${p:+--async-dns=false} \
            -d"$cache" -o"$file" -- "$1" || return 1
    fi
    xdg-open "$cache/$file"
}

p=$(getproxy "$url")

case "$url" in
    *reddit.com/gallery*|*i.redd.it*|*imgur.com*)
        gdl "$url" ;;

    *mkv|*webm|*mp4|*youtube.com/watch*|*youtube.com/playlist*|\
    *youtube.com/embed/*|*youtu.be*|*hooktube.com*|*bitchute.com*|\
    *odysee.com*|*v.redd*|*streamwo.com*|*streamable.com*|\
    *mp3|*mp3?source*|*flac|*opus)
        stream "$url" ;;

    *pdf|*cbz|*cbr)
        dl "$url" ;;

    *reddit.com*|*redd.it*)
        setsid -f $TERMINAL -e tuir -- "$url" >/dev/null 2>&1 ;;

    *)
        gdl "$url" && exit

        if $p timeout 8 curl -fsLr0-0 -- "$url" | head | grep -q 'content="PeerTube"'; then
            stream "$url"
            exit
        fi

        mime=$($p timeout 8 curl -fsLIw'%{content_type}\n' "$url" | tail -n1)
        case $mime in
            image/*|*/pdf|*/vnd.djvu|*/epub*) dl "$url" && exit ;;
            video/*|audio/*) stream "$url" && exit ;;
            */html*) $BROWSER "$url" && exit ;;
        esac

        action="$(
            printf 'Open\nCopy\nDownload\nStream\n' |
                dmenu  -p "Do What?${mime:+ (Type: $mime)}" ${WINDOWID:+-w $WINDOWID}
        )" || exit 0

        case "$action" in
            Download) dl "$url" ;;
            Stream) stream "$url" ;;
            Copy) printf %s "$url" | xclip -r -selection clipboard ;;
            Open) xdg-open "$url" ;;
        esac
    ;;
esac
