#!/bin/sh
# extract and open URLs from the contents of stdin.
# requires my "urltype" script,  dmenu, xurls, libnotify,
# mpv(+youtube-dl), moreutils, gallery-dl, and tuir(optional).

# config
cache=~/.cache/gallery-dl

[ -n "$1" ] && url="$(printf '%s\n' "$1" | xurls | head -n1)" || url="$(
    xurls | sort -u | ifne dmenu -p 'Select URL' -l 10 ${WINDOWID:+-w $WINDOWID}
)"
[ -z "$url" ] && exit

stream() {
    notify-send -u low PipeURL 'Opening Video...'
    $p mpv -quiet -- "$@" ||
        notify-send PipeURL 'Failed to open the Video.'
}

gdl() {
    imgs=$($p gallery-dl -d "$cache" -- "$@" 2>/dev/null) || return 1
    printf '%s\n' "$imgs" | sed 's/^# //' |
        xargs -d'\n' sh -c 'sxiv -a -- "$@" || mpv -quiet -- "$@"' ''
}

dl() {
    file=$(printf '%s\n' "$1" | md5sum | cut -d' ' -f1)
    if [ ! -r "$cache/$file" ]; then
        $p aria2c -q -x10 -s10 -k1M -m1 --no-conf ${p:+--async-dns=false} \
            -d"$cache" -o"$file" -- "$1" || return 1
    fi
    xdg-open "$cache/$file"
}

t=$(urltype "$url")
p=${t#* }
t=${t%% *}

case $t in
    gallery) gdl "$url" ;;
    document) dl "$url" ;;
    stream) stream "$url" ;;
    reddit) tuir -- "$url" ;;
    *) $BROWSER "$url" ;;
esac
