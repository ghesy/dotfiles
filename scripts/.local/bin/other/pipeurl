#!/bin/sh
# extract and open URLs from the contents of stdin.
# requires dmenu, xurls, libnotify, mpv (+youtube-dl), aria2,
# moreutils, gallery-dl, tuir (for reading reddit posts),
# and haxor-news (for reading hacker-news comments).

# config
cache=~/.cache/gallery-dl

main() {
    [ -n "$1" ] && url="$(printf '%s\n' "$1" | xurls | head -n1)" ||
        url="$(xurls | sort -u | ifne dmenu -p 'Select URL' -l 10 ${WINDOWID:+-w $WINDOWID})"
    [ -z "$url" ] && exit

    site=${url#*://}
    site=${site#www.}
    case $site in
        *.pdf|*.cbz|*.cbr|*.jpg|*.png|*.webp|*.gif) dl ;;
        reddit.com/gallery*|i.redd.it*|imgur.com/*|gfycat.com/*) gdl ;;
        *.mp4|*.mp4?*|*.webm|*.gifv|*.mkv|*.mp3|*.mp3?*|*.flac|*.opus|*.ogg|\
        youtube.com/watch*|youtube.com/playlist*|youtube.com/embed/*|youtube.com/shorts/*|youtu.be/*|\
        hooktube.com/watch*|bitchute.com/video/*|odysee.com/*:*|khanacademy.org/*/v/*|v.redd.it/*|\
        tiktok.com/@*/video/*|aparat.com/v/*|aparat.com/*/live|videos.lukesmith.xyz/w/*|streamff.com/v/*|\
        mixture.gg/v/*|streamgg.com/v/*|clippituser.tv/c/*|streamable.com/*|streamja.com/*) stream ;;
        reddit.com*|redd.it*) exec tuir $(printf '%s\n' "$url" | sed -E 's|.*/r/([^/]+)/?$|-s \1|') ;;
        news.ycombinator.com/*) $(getproxy 'hacker-news.firebaseio.com') hn view -c "${url##*id=}" | ${PAGER:-less} ;;
        *) exec xdg-open "$url" ;;
    esac
}

stream() {
    error=false
    notify-send -u low -t 1000 PipeURL 'Opening video...'
    msg=$($(getproxy "$url") mpv --msg-level=all=error -- "$url" 2>&1)
    case $?/$msg in
        2/*'Temporary failure in name resolution'*)
            proxychains -q mpv --msg-level=all=error -- "$url" || error=true ;;
        0/*) ;;
        *) error=true; printf '%s\n' "$msg" ;;
    esac
    [ "$error" = true ] && notify-send PipeURL 'Failed to open the video.'
}

gdl() {
    p=$(getproxy "$url")
    p=$(getproxy "$($p gallery-dl -G -- "$url" | head -n1)")
    imgs=$($p gallery-dl --no-mtime -d "$cache" -- "$url" 2>/dev/null) || return 1
    printf '%s\n' "$imgs" | sed 's/^# //' | xargs -d'\n' sh -c 'sxiv -a -- "$@" || mpv -quiet -- "$@"' ''
}

dl() {
    file=$(printf '%s\n' "$url" | md5sum | cut -d' ' -f1)
    if [ ! -r "$cache/$file" ]; then
        $(getproxy "$url") aria2c -q -x10 -s10 -k1M -m1 --no-conf \
            --async-dns=false -d"$cache" -o"$file" -- "$url" || return 1
    fi
    exec xdg-open "$cache/$file"
}

main "$@"
