#!/bin/sh
# extract and open URLs from the contents of stdin.
# option -c: take the next thing that is copied to clipboad as a url and open it
# requires dmenu, xurls, clipnotify, xclip, libnotify,
# mpv(+youtube-dl), curl, moreutils, gallery-dl, and tuir(optional).

if [ "$1" = -c ]; then
    [ "$FLOCKER" != "$(realpath -- "$0")" ] &&
        exec env FLOCKER="$(realpath -- "$0")" flock -en "$0" "$0" "$@"
    shift
    notify-send -u low PipeURL 'Listening to Clipboard...'
    clip=$(timeout 30s sh -c '
        while :; do
            echo PipeURL | xclip -selection clipboard || exit 1
            clipnotify || exit 1
            clip=$(xclip -o -selection clipboard)
            [ "$clip" = PipeURL ] && continue
            printf '%s\n' "$clip"
            break
        done
    ') || exit 1
    set -- "${clip:?}"
fi

[ -n "$1" ] && url="$(printf '%s\n' "$1" | xurls | head -n1)" || url="$(
    xurls | sort -u | ifne dmenu -p 'Select URL' -l 10 ${WINDOWID:+-w $WINDOWID}
)"

[ -z "$url" ] && exit
[ -n "$clip" ] && notify-send PipeURL 'Got it.'

gdl() {
    { gallery-dl -G -- "$@" || proxychains -q gallery-dl -G -- "$@" ;} 2>/dev/null
}

stream() {
    notify-send PipeURL 'Opening Video...'
    if timeout 10 curl -fsIL -- "$@" >/dev/null; then
        mpv -quiet -- "$@"
    else
        proxychains -q mpv -quiet -- "$@"
    fi || notify-send PipeURL 'Failed to open the Video.'
}

case "$url" in
    *reddit.com/gallery*|*i.redd.it*|*imgur.com*)
        gdl "$url" | xargs -d'\n' dl ;;

    *mkv|*webm|*mp4|*youtube.com/watch*|*youtube.com/playlist*|\
    *youtu.be*|*hooktube.com*|*bitchute.com*|*odysee.com*|*v.redd*|\
    *streamwo.com*|*streamable.com*)
        stream "$url" ;;

    *pdf|*cbz|*cbr|*mp3|*flac|*opus|*mp3?source*)
        dl "$url" ;;

    *reddit.com*|*redd.it*)
        setsid -f $TERMINAL -e tuir -- "$url" >/dev/null 2>&1 ;;

    *)
        if urls="$(gdl "$url")"; then
            printf '%s\n' "$urls" | xargs -d'\n' dl
            exit 0
        fi

        if curl -fsLr0-0 -- "$url" | grep -q 'content="PeerTube"'; then
            stream "$url"
            exit 0
        fi

        action="$(
            printf 'Download\nStream\nCopy\nOpen' |
                dmenu  -p 'Do What?' ${WINDOWID:+-w $WINDOWID}
        )" || exit 0

        case "$action" in
            Download) dl "$url" ;;
            Stream) stream "$url" ;;
            Copy) printf %s "$url" | xclip -r -selection clipboard ;;
            Open) xdg-open "$url" ;;
        esac
    ;;
esac
