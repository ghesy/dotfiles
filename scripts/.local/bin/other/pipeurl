#!/bin/sh
# extract and open URLs from the contents of stdin.
# requires dmenu, mpv, youtube-dl, gallery-dl, xurls, tuir.

[ -n "$1" ] && url="$(printf '%s\n' "$1" | xurls | head -n1)" || url="$(
    xurls | sort -u | ifne dmenu -p 'Select URL' -l 10 ${WINDOWID:+-w $WINDOWID}
)"

[ -z "$url" ] && exit

case "$url" in
    *reddit.com/gallery*|*i.redd.it*|*imgur.com*)
        gallery-dl -G "$url" 2>/dev/null | xargs -d'\n' dl ;;

    *mkv|*webm|*mp4|*youtube.com/watch*|*youtube.com/playlist*|\
    *youtu.be*|*hooktube.com*|*bitchute.com*|*odysee.com*|*v.redd*|\
    *streamwo.com*|*streamable.com*)
        mpv -quiet "$url" || torsocks mpv -quiet "$url" ;;

    *pdf|*cbz|*cbr|*mp3|*flac|*opus|*mp3?source*)
        dl "$url" ;;

    *reddit.com*|*redd.it*)
        setsid -f $TERMINAL -e tuir "$url" >/dev/null 2>&1 ;;

    *)
        if urls="$(gallery-dl -G "$url" 2>/dev/null)"; then
            printf '%s\n' "$urls" | xargs -d'\n' dl
            exit 0
        fi

        action="$(
            printf 'Open\nStream\nCopy\nBrowse' |
                dmenu  -p 'Do What?' ${WINDOWID:+-w $WINDOWID}
        )" || exit 0

        case "$action" in
            Open) dl "$url" ;;
            Stream) mpv -quiet "$url" || torsocks mpv -quiet "$url" ;;
            Copy) printf %s "$url" | xclip -r -selection clipboard ;;
            Browse)
                case "$url" in
                    http*)
                        case "$BROWSER" in
                            *fox*|*wolf*) $BROWSER --new-window "$url" ;;
                        esac
                    ;;
                    *) xdg-open "$url" ;;
                esac
        esac
    ;;
esac
