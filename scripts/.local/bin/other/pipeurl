#!/bin/sh
# extract and open URLs from the contents of stdin.
# requires dmenu, xurls, libnotify, mpv (+youtube-dl), aria2,
# moreutils, gallery-dl, tuir (for reading reddit posts),
# and haxor-news (for reading hacker-news comments).

# config
cache=~/.cache/gallery-dl

main() {
    [ -n "$1" ] && url="$(printf '%s\n' "$1" | xurls | head -n1)" ||
        url="$(xurls | sort -u | ifne dmenu -p 'Select URL' -l 10 ${WINDOWID:+-w $WINDOWID})"
    [ -z "$url" ] && exit

    case $url in
        *.pdf|*.cbz|*.cbr|*.jpg|*.png|*.webp|*.gif) dl ;;
        *reddit.com/gallery*|*i.redd.it*|*imgur.com/*|*gfycat.com/*) gdl ;;
        *.mp4|*.mp4?*|*.webm|*.gifv|*.mkv|*.mp3|*.mp3?*|*.flac|*.opus|*youtube.com/watch*|\
        *youtube.com/playlist*|*youtube.com/embed/*|*youtu.be/*|*hooktube.com/*|\
        *bitchute.com/*|*odysee.com/*|*v.redd*|*streamwo.com/*|*streamable.com/*|*streamff.com/*|\
        *streamja.com/*|*videos.lukesmith.xyz/*|*tiktok.com/*|*khanacademy.org/*) stream ;;
        *reddit.com*|*redd.it*) exec tuir $(printf '%s\n' "$url" | sed -E 's|.*/r/([^/]+)/?$|-s \1|') ;;
        *news.ycombinator.com/*) $(getproxy 'hacker-news.firebaseio.com') hn view -c "${url##*id=}" | ${PAGER:-less} ;;
        *) exec xdg-open "$url" ;;
    esac
}

stream() {
    notify-send -u low PipeURL 'Opening video...'
    $(getproxy "$url") mpv -quiet -- "$url" || notify-send PipeURL 'Failed to open the video.'
}

gdl() {
    imgs=$($(getproxy "$(gallery-dl -G -- "$url" | head -n1)") gallery-dl -d "$cache" -- "$url" 2>/dev/null) || return 1
    printf '%s\n' "$imgs" | sed 's/^# //' | xargs -d'\n' sh -c 'sxiv -a -- "$@" || mpv -quiet -- "$@"' ''
}

dl() {
    file=$(printf '%s\n' "$url" | md5sum | cut -d' ' -f1)
    if [ ! -r "$cache/$file" ]; then
        $(getproxy "$url") aria2c -q -x10 -s10 -k1M -m1 --no-conf \
            --async-dns=false -d"$cache" -o"$file" -- "$url" || return 1
    fi
    exec xdg-open "$cache/$file"
}

main "$@"
