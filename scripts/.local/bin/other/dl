#!/bin/sh
# download files from given URLs in parallel using aria2c or curl, then open them.
# if you give the same URL again, it will open the already downloaded file.
# if the url is censored, it will download it through tor using torsocks.

# config
cache=~/.cache/dl

main()
{
    mkdir -p "$cache" || return 1
    for url; do
        file="$(download "$url")" && xdg-open "$file" &
    done
    wait
}

download()
{
    [ -z "$1" ] && return 1
    file="$(echo "$1" | sha256sum | cut -d' ' -f1)"
    if [ ! -r "$cache/$file" ]; then
        tor='' dlcmd "$1" "$file" || tor=torsocks dlcmd "$1" "$file" || return 1
    fi
    printf '%s\n' "$cache/$file"
}

dlcmd()
{
    [ -n "$tor" ] &&
        ! torsocks timeout 8 curl -s icanhazip.com >/dev/null 2>&1 &&
        return 1

    if command -v aria2c >/dev/null; then
        $tor aria2c --quiet --no-conf ${tor:+--async-dns=false} \
            --max-connection-per-server=8 --split=8 --min-split-size=1M \
            --disable-ipv6=true --timeout=5${tor:+0} --connect-timeout=5${tor:+0} \
            --dir="$cache" --out="$2" -- "$1"
    else
        $tor curl --silent --connect-timeout 5${tor:+0} --max-time 300 \
            ---xattr --output-dir "$cache" --output "$2" -- "$1"
    fi
}

main "$@"
