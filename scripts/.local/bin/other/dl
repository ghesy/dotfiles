#!/bin/sh
# download files from given URLs in parallel using aria2c or curl, then open them.
# if you give the same URL again, it will open the already downloaded file.
# if the url is censored, it will download it via proxychains.

# config
cache=~/.cache/dl

main() {
    mkdir -pm700 "$cache" || exit 1
    for url; do
        file="$(download "$url")" && xdg-open "$file" &
    done
    wait
}

download() {
    [ -z "$1" ] && return 1
    file="$(printf '%s\n' "$1" | sha256sum | cut -d' ' -f1)"
    if [ ! -r "$cache/$file" ]; then
        p='' dlcmd "$1" "$file" ||
            p='proxychains -q' dlcmd "$1" "$file" ||
            return 1
    fi
    printf '%s\n' "$cache/$file"
}

dlcmd() {
    $p aria2c --quiet --no-conf -x10 -s10 -k1M -m1 -t10${p:+0} \
        --connect-timeout=10${p:+0} ${p:+--async-dns=false} \
        -d"$cache" -o"$2" -- "$1"
}

main "$@"
