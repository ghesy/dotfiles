#!/bin/sh
# download files from given URLs in parallel using aria2c or curl, then open them.
# if you give the same URL again, it will open the already downloaded file.
# if the url is censored, it will download it via proxychains.

# config
cache=~/.cache/dl

main()
{
    mkcachedir
    for url; do
        file="$(download "$url")" && xdg-open "$file" &
    done
    wait
}

download()
{
    [ -z "$1" ] && return 1
    file="$(echo "$1" | sha256sum | cut -d' ' -f1)"
    if [ ! -r "$cache/$file" ]; then
        proxy='' dlcmd "$1" "$file" || proxy='proxychains -q' dlcmd "$1" "$file" || return 1
    fi
    printf '%s\n' "$cache/$file"
}

dlcmd()
{
    [ -n "$proxy" ] &&
        ! $proxy timeout 8 curl -s ping.archlinux.org >/dev/null 2>&1 &&
        return 1

    if command -v aria2c >/dev/null; then
        $proxy aria2c --quiet --no-conf ${proxy:+--async-dns=false} \
            --max-connection-per-server=8 --split=8 --min-split-size=1M \
            --disable-ipv6=true --timeout=10${proxy:+0} --connect-timeout=10${proxy:+0} \
            --max-tries=1 --dir="$cache" --out="$2" -- "$1"
    else
        $proxy curl --silent --connect-timeout 10${proxy:+0} --max-time 300 \
            ---xattr --output-dir "$cache" --output "$2" -- "$1"
    fi
}

mkcachedir()
{
    if [ ! -w "$cache" ]; then
        mkdir -m700 "$cache" || {
            echo Couldn\'t make directory "$cache". >&2
            exit 1
        }
    fi
}

main "$@"
