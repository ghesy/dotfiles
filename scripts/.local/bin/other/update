#!/bin/bash
# update my dotfiles, my syncthing-synced files and my suckless software repoes.
set -eE
trap 'echo failed at line $LINENO: $BASH_COMMAND' ERR

f() { "$@" || kill $$ ;}

pushd /media/syncthing/Main >/dev/null
    basename "$PWD"
    ./install.sh
popd >/dev/null

pushd ~/.dots >/dev/null
    basename "$PWD"
    if [ "$(f git branch --show)" != master ]; then
        echo dotfiles is not on the proper branch
    elif [ -n "$(f git status --porcelain)" ]; then
        echo dotfiles contains uncommited changes
    else
        [ "$(f git pull)" != 'Already up to date.' ] &&
            echo y | ./install.sh && echo
    fi
popd >/dev/null

for dir in ~/Repositories/suckless/*/; do
    pushd "$dir" >/dev/null
        basename "$PWD"
        if [[ $(f git branch --show) != my-* ]]; then
            echo "$(basename "$dir") is not on the proper branch"
        elif [ -n "$(f git status --porcelain)" ]; then
            echo "$(basename "$dir") contains uncommited changes"
        else
            [ "$(f git pull)" != 'Already up to date.' ] &&
                make && sudo make install
        fi
    popd >/dev/null
done
