#!/bin/sh
# Run with the -i option to start stalonetray and hide it,
# Then run without any options to show and hide stalonetray.

# config
winid="${XDG_RUNTIME_DIR:-/tmp}/tray/winid"

main()
{
    case "$1" in
        -i) init ;;
        *) toggle ;;
    esac
}

toggle()
{
    is_running || die 'Tray is not running, start with the -i option.'
    is_visible && hide || show
}

init()
{
    is_running && die Already running.
    stalonetray ${STALONETRAYRC:+--config "$STALONETRAYRC"} &
    sleep 0.3
    save_winid
    make_wm_ignore_tray
    hide
    wait
}

is_running()
{
    pidof -q stalonetray
}

is_visible()
{
    xwininfo -id "$(cat "$winid")" | grep -q IsViewable
}

hide()
{
    xdotool windowunmap "$(cat "$winid")"; return 0
}

show()
{
    xdotool windowmap "$(cat "$winid")"; return 0
}

save_winid()
{
    mkdir -p "$(dirname "$winid")" || die Could not make temporary directory.
    xdotool search --name stalonetray > "$winid"
}

make_wm_ignore_tray()
{
    xdotool set_window --overrideredirect 1 "$(cat "$winid")"
}

check_deps()
{
    for prog in stalonetray xdotool xwininfo; do
        command -v $prog >/dev/null || die dependency not installed: $prog
    done
}

die()
{
    printf '%s\n' "tray: $*" >&2
    exit 1
}

trap exit HUP
trap "pkill -P $$" EXIT

main "$@"
