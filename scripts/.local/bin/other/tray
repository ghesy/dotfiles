#!/bin/sh
# Run with the -i option to start stalonetray and hide it,
# Then run without any options to show and hide stalonetray.

main() {
    winid=${XDG_RUNTIME_DIR:-/tmp}/tray-winid
    depcheck
    case "$1" in
        -i) init ;;
        *) toggle ;;
    esac
}

toggle() {
    is_running || die Tray is not running, start with the -i option.
    is_visible && hide || show
}

init() {
    is_running && die Already running.
    sh -c '
        sleep 0.3
        xdotool search --name stalonetray > "$0"
        xdotool set_window --overrideredirect 1 "$(cat "$0")"
        xdotool windowunmap "$(cat "$0")"
    ' "$winid" &
    exec stalonetray ${STALONETRAYRC:+--config "$STALONETRAYRC"}
}

is_running() { pidof -q stalonetray ;}
is_visible() { xwininfo -id "$(cat "$winid")" | grep -q IsViewable ;}
hide() { xdotool windowunmap "$(cat "$winid")" ||: ;}
show() { xdotool windowmap   "$(cat "$winid")" ||: ;}

depcheck() {
    for prog in stalonetray xdotool xwininfo; do
        command -v $prog >/dev/null || die Dependency not installed: $prog
    done
}

die() {
    printf '%s\n' "tray: $*" >&2
    exit 1
}

main "$@"
