#!/bin/sh
# this script controls cpu's power and performance settings.
# run this script when laptop charger
# connects / disconnects via the provided udev rule.

# sysfs files for controlling cpu parameters
cpu=/sys/devices/system/cpu/cpufreq
no_turbo=/sys/devices/system/cpu/intel_pstate/no_turbo
pid=/var/run/pwr.pid

main()
{
    [ "$1" = -f ] && shift || fork "$@"
    refresh_battery_module
    pid
    case $1 in
        high) cpupwr high ;;
        low) cpupwr low; sata_pwrsave ;;
    esac
}

refresh_battery_module()
{
    eval "$(printf '%s battery;' /home/*/.local/bin/dwmbar/dwmbarref)"
}

# change cpu's frequency and turbo settings
cpupwr()
{
    case $1 in
        high) no_turbo_val=0; energy_val=performance ;;
        low)  no_turbo_val=1; energy_val=balance_power ;;
    esac

    write $no_turbo_val $no_turbo
    write $energy_val $cpu/policy*/energy_performance_preference
}

# apply sata powersaving settings
sata_pwrsave()
{
    write auto \
        /sys/class/ata_port/ata*/power/control \
        /sys/block/sd*/device/power/control
}

write()
{
    value="$1"; shift

    for file; do
        [ ! -e "$file" ] && echo error: "$file" doesn\'t exist. >&2 && return 1
        for i in $(seq 1 120); do
            printf '%s\n' "$value" | tee "$file" >/dev/null && break
            sleep 2
        done &
    done
    wait
}

pid()
{
    [ -r $pid ] && kill $(cat $pid)
    trap cleanup EXIT
    echo $$ > $pid
}

fork()
{
    setsid -f "$0" -f "$@" >/dev/null 2>&1
    exit
}

cleanup()
{
    rm $pid
    kill 0
}

trap 'pkill -P $$' EXIT
main "$@"
