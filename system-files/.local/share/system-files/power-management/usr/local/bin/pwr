#!/bin/sh
# this script controls cpu's power and performance settings.
# run this script when laptop charger
# connects / disconnects via the provided udev rule.

# sysfs files for controlling cpu parameters
cpu=/sys/devices/system/cpu/cpufreq
no_turbo=/sys/devices/system/cpu/intel_pstate/no_turbo
pid=/var/run/pwr.pid

# path to this script
bin="$0"

main()
{
    refresh_battery_module
    pid
    case $1 in
        high) cpupwr high ;;
        low) cpupwr low; sata_pwrsave ;;
    esac
}

refresh_battery_module()
{
    /home/*/.local/bin/dwmbar/dwmbarref battery
}

# change cpu's frequency and turbo settings
cpupwr()
{
    case $1 in
        high) no_turbo_val=0; energy_val=performance ;;
        low)  no_turbo_val=1; energy_val=balance_power ;;
    esac

    write $no_turbo_val $no_turbo
    write $energy_val $cpu/policy*/energy_performance_preference
}

# apply sata powersaving settings
sata_pwrsave()
{
    write auto \
        /sys/class/ata_port/ata*/power/control \
        /sys/block/sd*/device/power/control
}

write()
{
    for i in $(seq 1 120); do
        printf '%s\n' "$1" | tee "$@" >/dev/null && break
        sleep 2
    done
}

pid()
{
    [ -r $pid ] && kill $(cat $pid)
    trap cleanup EXIT
    echo $$ > $pid
}

cleanup()
{
    rm $pid
    kill 0
}

main "$@"
exit
